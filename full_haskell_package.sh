#!/usr/bin/env bash

[[ -n "$OUT_DIR" ]] || {
    echo "Error, full_haskell_package.sh needs an 'OUT_DIR'" 1>&2
    exit 1
}

echo "Running mk_signature.sh" 1>&2
HS=$(./mk_signature.sh) || {
    echo -e "Failed to make Haskell file\nHS:\n$HS\n\n" 1>&2
    exit 1
}

# Remove the generated signature, as it's incompatible with QuickSpec 1, and
# remove the import of QuickSpec 2
PATCHED=$(echo "$HS" | grep -B 999999999 "^sig =$" |
                       head -n -1                  |
                       grep -v "import qualified QuickSpec as QS")

mkdir -p "$OUT_DIR/src"

echo "Copying to '$OUT_DIR/src/A.hs'" 1>&2
echo "$PATCHED" > "$OUT_DIR/src/A.hs"

echo "Making cabal file" 1>&2
echo "-- Initial tip-benchmark-sig.cabal generated by cabal init.  For further
-- documentation, see http://haskell.org/cabal/users-guide/

name:                tip-benchmark-sig
version:             0.1.0.0
synopsis:            Auto-generated package for theory exploration
-- description:
homepage:            http://example.org
license:             PublicDomain
license-file:        LICENSE
author:              Chris Warburton
maintainer:          chriswarbo@gmail.com
-- copyright:
category:            Testing
build-type:          Simple
-- extra-source-files:
cabal-version:       >=1.10

library
  exposed-modules:     A
  -- other-modules:
  -- other-extensions:
  build-depends:       base >=4.8
                     , quickspec
                     , QuickCheck
                     , testing-feat
  hs-source-dirs:      src
  default-language:    Haskell2010
" > "$OUT_DIR/tip-benchmark-sig.cabal"

echo "Making license" 1>&2
echo "Auto-generated from https://github.com/tip-org/benchmarks, the same
LICENSE applies" > "$OUT_DIR/LICENSE"

exit 0
